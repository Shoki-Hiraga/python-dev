from setting_file.header import *

# # スプレッドシート認証
# scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
# credentials = ServiceAccountCredentials.from_json_keyfile_name('C:/Users/STAFF1088/AppData/Local/Programs/Python/python-scrape.json', scope)
# gc = gspread.authorize(credentials)

# # スプレッドシート設定
# worksheet = gc.open("Python_scrape_API").sheet1


# ファイルパス
csv_directory = csv_output_path.out_office
# csv_directory = csv_output_path.out_main
# csv_directory = csv_output_path.out_raytrek
csv_filename = "Search Console_API_Query.csv"
output_file = os.path.join(csv_directory, csv_filename)


# 対象のサイトURLを指定します
site_url = 'https://www.qsha-oh.com/'

# JSONファイルのパスを指定
SERVICE_ACCOUNT_FILE = api_json.qsha_oh

# Search Console APIの認証情報を指定
credentials = service_account.Credentials.from_service_account_file(
    SERVICE_ACCOUNT_FILE, scopes=['https://www.googleapis.com/auth/webmasters.readonly']
)

# Search Console APIのバージョンとプロジェクトIDを指定します
api_version = 'v3'
service = build('webmasters', api_version, credentials=credentials)

# 検索クエリに一致したデータを取得する関数を定義します
def get_search_query_data(site_url, query):
    request = {
        'startDate': '2023-04-01',
        'endDate': '2024-08-31',
        'dimensions': ['query', 'page'],  # dimensionsに'page'を追加
        'searchType': 'web',
        'dimensionFilterGroups': [{
            'filters': [{
                'dimension': 'query',
               'operator': 'equals',
            #    'operator': 'contains',
                'expression': query
            }]
        }]
    }

    try:
        response = service.searchanalytics().query(siteUrl=site_url, body=request).execute()
        return response.get('rows', []), query
    except Exception as e:
        print(f'Error retrieving data for query {query}: {e}')
        return [], query


header_row = ['検索クエリ', 'URL', '表示回数', 'クリック数', 'クリック率', '掲載順位']


# 複数の検索クエリを指定します
queries = [
'不動車とは',
'不動車買い取り',
'中古車 横浜 安い',
'出張 不動車',
'出張買取 不動車',
'動かない 車 買取',
'動かない車 買い取り',
'動かない車 買取',
'動かない車買取',
'地ベラ 不動車査定',
'旧車 不動車',
'旧車王 ネクステージ',
'旧車王 振込',
'旧車王 更新情報',
'旧車王 査定',
'旧車王 購入',
'王 不動車',
'王 買取 不動車',
'車 一括査定 危険',
'車 不動車 買取',
'車 出張査定 三重',
'車 売却 不動車',
'車 査定 当日',
'車 買取 不動 車',
'車 買取 不動車',
'車 買取 動か ない 車',
'車査定 不動車',
'車査定 当日',
'車王',
'車買取 不動車',
'車買取 動かない',
'痛車 買取',
'痛車 売ります',
'痛車 なぜ',
'amg 痛車',
'citroen 痛車',
'fd 痛車',
'gt300 痛車',
's13 痛車',
's660 痛車',
'そてガレ 査定',
'アストンマーティン 痛車',
'アメリカ 痛車',
'カーズ 痛車',
'スカイライン 痛車',
'スポーツカー 痛車',
'テスラ 痛車',
'ビアンキ 買取',
'ピンクの車 痛い',
'ブガッティ 痛車',
'ベンツ 痛車',
'マクラーレン 痛車',
'ラッピング 痛車',
'ランクル 痛車',
'ランボルギーニ 痛車',
'ランボルギーニ痛車',
'レクサス 痛車',
'ロールスロイス 痛車',
'内装 だけ 痛車',
'内装 痛車',
'外車 痛車',
'岡山 痛車',
'急速車王',
'新日本橋 車買取',
'新潟 痛車',
'旧車 痛車',
'旧車王 振込',
'旧車王 更新情報',
'旧車王 最新情報',
'旧車王 買取',
'東方 車',
'東方車',
'査定無料 買取 オススメ 車',
'桜川 車買取',
'桜田門 車買取',
'沖縄 痛車',
'熊本 痛車',
'痛 車',
'痛い車',
'痛車',
'痛車 いくら',
'痛車 いくらかかる',
'痛車 おすすめ 車種',
'痛車 アウト',
'痛車 イタ車',
'痛車 カーセンサー',
'痛車 スポーツカー',
'痛車 スポーツカー なぜ',
'痛車 デザイン コツ',
'痛車 デザイン 依頼',
'痛車 デメリット',
'痛車 ラッピング',
'痛車 ラッピング 費用',
'痛車 ランキング',
'痛車 ランボルギーニ',
'痛車 中古',
'痛車 中古 販売',
'痛車 中古車',
'痛車 依頼',
'痛車 価格',
'痛車 値段',
'痛車 内装',
'痛車 写真',
'痛車 岡山',
'痛車 意味',
'痛車 新潟',
'痛車 業者',
'痛車 法律',
'痛車 熊本',
'痛車 画像',
'痛車 相場',
'痛車 福岡',
'痛車 読み方',
'痛車 販売',
'痛車 車検',
'痛車 車種',
'痛車 車種ランキング',
'痛車 金持ち',
'痛車 金額',
'痛車 静岡',
'痛車 鹿児島',
'痛車とは',
'痛車の意味',
'痛車アウト',
'痛車デザイン 依頼',
'痛車ラッピング',
'痛車中古',
'痛車中古車',
'痛車専門店',
'痛車画像',
'痛車費用',
'神田 車買取',
'福島 車 買取',
'赤坂 車買取',
'車 ステッカー 売る時',
'車 ラッピング 痛車',
'車 内装 アニメ',
'車 出張査定 さいたま',
'車 出張買取 福島',
'車 売りたい',
'車 売却',
'車 売却 ステッカー',
'車 減額 目安',
'車 痛車',
'車 買取 安全',
'車 買取 時間',
'車 買取 高',
'車 買取り査定 ステッカー',
'車 高価 買取',
'車 高価買取',
'車つねただ',
'車を売る',
'車を売るなら',
'車売る',
'車売却 査定',
'車査定 内装',
'車王',
'車買取 三重',
'車買取 交渉',
'車買取会社',
'車高価買取',
'骨格 車',
'高価 買取 車',
'高価買取 車',
'高価買取車',
'鳥取 痛車',
'ランド王',
'ランクル 買取',
'ランクル買取専門店',
'ランドクルーザー 買取',
'ランクル買取',
'ランド王 口コミ',
'旧車王',
'ランクル 売却',
'ランクル買取 高い',
'ランクル 買取 専門',
'ランクル売るなら',
'ランクル売却',
'ランクル 査定',
'ランクル 高価買取',
'ランドクルーザー 高価買取',
'ランドクルーザー買取',
'きゅうしゃおう',
'プラド 売るタイミング',
'ランクル査定',
'ランドクルーザー 売却',
'ランドクルーザー 査定',
'旧車王 購入',
'045 476 1019',
'120プラド 高騰',
'250 ランクル',
'2ドア ランクル',
'78プラド 値上がり',
'78プラド 高騰',
'95プラド 後悔',
'bj73v',
'brabus land cruiser',
'landcruiser 250',
'local guide program',
'lx 売却',
'lx 査定',
'px10 ランクル',
'qsha',
'zx 査定',
'きゅうしゃ',
'きゅうしゃおう 販売',
'きゅうどうかおうどうか',
'ぜったい王性',
'カレント自動車 旧車王',
'クラシックカー 買取',
'クラシックカー 買取 おすすめ',
'クラシックカー買取',
'シープラス買取',
'ディーゼル 査定',
'トゥループキャリア',
'トヨタ ランドクルーザー 買取',
'トヨタ ランドクルーザー76 査定',
'ハイエースバン 買取 相場表',
'ビアンキ 買取',
'プラド 20万キロ 下取り',
'プラド 売るなら どこ',
'プラド 売却',
'プラド買取専門',
'ランクル',
'ランクル 200 口コミ',
'ランクル 250',
'ランクル 2ドア',
'ランクル 4ナンバー',
'ランクル 60 復刻',
'ランクル px10',
'ランクル zx 買取相場',
'ランクル いくらで売れる',
'ランクル シグナス 現行',
'ランクル ナロー化',
'ランクル 下取り',
'ランクル 個人売買',
'ランクル 売る',
'ランクル 売る 高く',
'ランクル 売るタイミング',
'ランクル 売値',
'ランクル 売却価格',
'ランクル 専門店',
'ランクル 買取 おすすめ',
'ランクル 買取 相場',
'ランクル 買取価格',
'ランクル 買取相場',
'ランクル100 前期 故障',
'ランクル120 丸目',
'ランクル200 zx 買取相場',
'ランクル200 後悔',
'ランクル200 買取',
'ランクル250',
'ランクル250 いくら',
'ランクル250 ナローボディ',
'ランクル250 丸目',
'ランクル250 買取',
'ランクル250の販売時期はいつですか？',
'ランクル250口コミ',
'ランクル2ドア',
'ランクル300 下取り',
'ランクル300 売値',
'ランクル300 売却',
'ランクル300 買取',
'ランクル300 買取価格',
'ランクル300 買取相場',
'ランクル300売値',
'ランクル300買取',
'ランクル300買取価格',
'ランクル40 ピックアップ',
'ランクル40 買取',
'ランクル60 ショート',
'ランクル60 復刻',
'ランクル70 px10 中古',
'ランクル70 ショート 復刻',
'ランクル70 ネオクラシック 中古',
'ランクル70 リセール崩壊',
'ランクル70 値下がり',
'ランクル70 再販 2023',
'ランクル70 売値',
'ランクル70 買取',
'ランクル70 買取価格',
'ランクル80 値下がり',
'ランクル80 復刻',
'ランクル80 買取',
'ランクルpx10',
'ランクルシグナス 値上がり',
'ランクル売値',
'ランクル専門',
'ランクル買取相場',
'ランクル高く買い取り',
'ランクル高価買取',
'ランクル高額買取',
'ランド 査定',
'ランド 王 比較',
'ランド 買取 比較',
'ランドクルーザー',
'ランドクルーザー 200 zx 買取相場',
'ランドクルーザー 200 買取',
'ランドクルーザー 2015 年 式 買取 価格',
'ランドクルーザー 250',
'ランドクルーザー 56',
'ランドクルーザー カスタム',
'ランドクルーザー ランクル 買取',
'ランドクルーザー 下取り',
'ランドクルーザー 売る',
'ランドクルーザー 売値',
'ランドクルーザー 専門店',
'ランドクルーザー 福岡',
'ランドクルーザー 買取 価格',
'ランドクルーザー 買取 相場',
'ランドクルーザー 買取り',
'ランドクルーザー 買取相場',
'ランドクルーザー 車買取',
'ランドクルーザー 高額査定',
'ランドクルーザー200 zx 買取相場',
'ランドクルーザー205',
'ランドクルーザー250',
'ランドクルーザー300 売却',
'ランドクルーザー300 査定',
'ランドクルーザー300 買取',
'ランドクルーザー300 買取価格',
'ランドクルーザー300 買取相場',
'ランドクルーザー300 高価買取',
'ランドクルーザー40 復刻',
'ランドクルーザー40 買取',
'ランドクルーザー40 買取り',
'ランドクルーザー55 買取',
'ランドクルーザー55 買取り',
'ランドクルーザー56',
'ランドクルーザー60 復刻',
'ランドクルーザー78 トゥループキャリア',
'ランドクルーザー80 mt',
'ランドクルーザーバン 買取',
'ランドクルーザー専門店',
'ランドクルーザー買取相場',
'ランドロード買取',
'京都 車買取 ランドクルーザー',
'北海道 ランクル専門店',
'古いランドクルーザー',
'売値',
'夢100 査定',
'宇治市 車売却 ランドクルーザー',
'宇治市 車売却 ランドクルーザー 下取り',
'宇治市 車売却 ランドクルーザー 価格',
'宇治市 車売却 ランドクルーザー 査定',
'宇治市 車売却 ランドクルーザー 見積もり',
'宇治市 車売却 ランドクルーザー 走行距離',
'宇治市 車買取 ランクル',
'岡山 車買取 ランクル',
'希少車 買取',
'旧 車 買取',
'旧車 売る',
'旧車 売却',
'旧車 査定',
'旧車 買い取り',
'旧車 買取',
'旧車 買取 おすすめ',
'旧車 買取 相場',
'旧車 買取価格',
'旧車 買取相場',
'旧車 高く売る',
'旧車 高価買取',
'旧車売るなら',
'旧車査定',
'旧車王 ネクステージ',
'旧車王 レビュー',
'旧車王 個人売買',
'旧車王 写真',
'旧車王 在庫',
'旧車王 店舗',
'旧車王 評判',
'旧車王 販売',
'旧車王 買取',
'旧車王 買取 評判',
'旧車王 車買取',
'旧車買い取り',
'旧車買取',
'旧車買取り',
'旧車買取ドットコム',
'旧車買取専門店',
'旧車買取相場',
'旧車高価買取',
'熊本 ランクル 専門店',
'王 ランド',
'王 査定だけ',
'王車',
'福岡 ランクル',
'買取ランド',
'車 出張査定',
'車 手放す 後悔',
'車 査定 東京',
'車 買取 ソッキン 王',
'車 買取 即日',
'車王',
'車買取',
'車買取 出張',
'近くの車買取専門店',
'ポルシェ 911 旧車',
'911 リセールバリュー',
'911 下取り',
'911 売却',
'911 旧車',
'911 査定',
'911 買取',
'911 買取相場',
'911爆料王',
'996カレラ',
'mania-oh.com',
'rwb bakajin',
'オートスポーツ ポルシェ 評判',
'キューナイン買取',
'ナイン 買取',
'ナインカレント',
'ポルシェ 911 売却',
'ポルシェ 911 旧車 値段',
'ポルシェ 911 査定',
'ポルシェ 911 買取',
'ポルシェ 911 買取相場',
'ポルシェ 911カレラ 買取',
'ポルシェ 911旧車',
'ポルシェ 930 ターボs フラットノーズ 売却',
'ポルシェ 930 ターボs フラットノーズ 査定',
'ポルシェ 930 ターボs フラットノーズ 買取',
'ポルシェ 993 売却',
'ポルシェ ゲンバラ 値段',
'ポルシェ 中古 買取',
'ポルシェ 中古買取',
'ポルシェ 売る',
'ポルシェ 売却',
'ポルシェ 旧車',
'ポルシェ 旧車 安い',
'ポルシェ 旧車 専門店',
'ポルシェ 旧車 買取',
'ポルシェ 昔の車',
'ポルシェ 査定',
'ポルシェ 評判',
'ポルシェ 買取',
'ポルシェ 買取 価格',
'ポルシェ 買取 相場',
'ポルシェ 買取り',
'ポルシェ 買取価格',
'ポルシェ 買取専門',
'ポルシェ 買取相場',
'ポルシェ 高く売る',
'ポルシェ 高く売れる',
'ポルシェ911 ターボ 買取 愛知',
'ポルシェ911 旧車',
'ポルシェ911 買取',
'ポルシェ911 買取相場',
'ポルシェ911 高価査定',
'ポルシェ911 高価買取',
'ポルシェ911 高額買取',
'ポルシェ旧車',
'ポルシェ査定',
'ポルシェ買取',
'ポルシェ買取専門店',
'マニア王 評判',
'ラウヴェルトベグリッフ (rwb)',
'事故車 買取 ポルシェ',
'旧車 ポルシェ',
'昔のポルシェ',
'昔のポルシェ911',
'金融車 ナイン',
'事故車王',
'旧車王',
'旧車王 写真',
'水没車 買取',
'事故車買取王',
'旧車 不動車',
'水没車 買取 相場',
'2000gt 事故',
'2000gt 廃車',
'lg車 買取 愛知',
'rx 廃車',
'はいどうも最高のs600',
'アウディ rs4 売値',
'アストン マーティン 故障',
'カムロード 廃車',
'クルマ 王 やばい',
'クーペ 廃車',
'スカイライン 事故車',
'スポーツ800 廃車',
'スープラ 廃車',
'テスラ 廃車',
'テスラ 水没',
'バル 売却額',
'ランクル 事故車 買取',
'下取り0円の車も高価買取り 水没車',
'不動 車 買取',
'不動車 売る',
'不動車 売却',
'不動車 廃車',
'不動車 査定',
'不動車 買い取り',
'不動車 買取',
'不動車 買取 山梨',
'不動車 買取 東京',
'不動車 買取 相場',
'不動車 買取 高額',
'不動車 車 買取',
'不動車 高価買取',
'不動車買取',
'事故 売却',
'事故 車 買取',
'事故車 スポーツ カー',
'事故車 不動 車 買取',
'事故車 再生',
'事故車 売る',
'事故車 売却',
'事故車 売却 相場',
'事故車 廃車買取',
'事故車 画像',
'事故車 買い取り',
'事故車 買取',
'事故車 買取 bmw',
'事故車 買取 いくら',
'事故車 買取 オペル',
'事故車 買取 クライスラー',
'事故車 買取 ダッジ',
'事故車 買取 デイムラー',
'事故車 買取 フォード',
'事故車 買取 マセラティ',
'事故車 買取 マツダ',
'事故車 買取 ランボルギーニ',
'事故車 買取 事例',
'事故車 買取 値段',
'事故車 買取 和歌山',
'事故車 買取 大阪',
'事故車 買取 富山',
'事故車 買取 山梨',
'事故車 買取 島根',
'事故車 買取 愛知',
'事故車 買取 日産',
'事故車 買取 東京',
'事故車 買取 査定',
'事故車 買取 沖縄',
'事故車 買取 王',
'事故車 買取 相場',
'事故車 買取 石川',
'事故車 買取 群馬',
'事故車 買取 長崎',
'事故車 買取り',
'事故車 買取査定',
'事故車 買取相場',
'事故車 高価買取',
'事故車 高価買取 東京',
'事故車 高額 買取',
'事故車買い取り',
'事故車買取',
'事故車買取 スポーツカー',
'事故車買取 埼玉',
'事故車買取 島根',
'事故車買取 東京',
'事故車買取 東京都',
'事故車買取 相場',
'事故車買取 長野',
'事故車買取り',
'事故車買取り 相場',
'事故車買取相場',
'動かない 車 買取',
'動かない車 買い取り',
'動かない車 買取',
'動かない車買取',
'宮城 事故車買取 高価',
'廃車 スポーツ カー',
'廃車 スポーツカー',
'廃車買取王',
'愛知 水没車買取',
'故障車 廃車',
'故障車 廃車 引き取り',
'故障車 引き取り',
'故障車 買い取り 東京',
'故障車 買取',
'故障車 買取 東京',
'故障車 買取 査定',
'故障車 買取 相場',
'故障車 買取 高額',
'旧車 事故',
'旧車 廃車',
'旧車王 ネクステージ',
'旧車王 安い',
'旧車王 更新情報',
'旧車王 買取',
'水没 廃車',
'水没 車 廃車',
'水没 車 買取',
'水没 車 買取 おすすめ',
'水没車 パーツ 買取',
'水没車 パーツ 買取査定',
'水没車 パーツ 高価買取',
'水没車 事故車',
'水没車 再生',
'水没車 処分',
'水没車 売る',
'水没車 売却',
'水没車 廃車',
'水没車 引き上げ',
'水没車 復活',
'水没車 査定',
'水没車 画像',
'水没車 買い取り',
'水没車 買取 岡山',
'水没車 買取 愛知',
'水没車 買取り',
'水没車買取',
'王 不動車',
'王 事故車',
'王 事故車 買取'
    ]

# 全体の結果を格納するリストを作成
all_results = []

# CSVファイルのヘッダー行を書き込む
with open(output_file, 'w', newline='', encoding='utf-8') as csvfile:
    csv_writer = csv.writer(csvfile)
    csv_writer.writerow(header_row)
    # # スプレッドシートにヘッダー行を書き込む
    # worksheet.append_row(header_row, value_input_option='USER_ENTERED')

try:
    for query in queries:
        # クエリの統計情報を取得
        search_query_data, original_query = get_search_query_data(site_url, query)

        # ランダムな遅延処理を追加
        delay = random.uniform(1.5, 3.5)
        print(f'遅延処理 {delay} 秒')
        time.sleep(delay)

        # 結果をCSVファイルに追加
        with open(output_file, 'a', newline='', encoding='utf-8') as csvfile:
            csv_writer = csv.writer(csvfile)

            if not search_query_data:  # データがない場合
                csv_writer.writerow([original_query, '0', '0', '0', '0'])
                # worksheet.append_row([original_query, '0', '0', '0', '0'])

                print(f'検索クエリ: {original_query}, データがありません')
            else:
                for row in search_query_data:
                    query = row['keys'][0]
                    page_url = row['keys'][1]  # URLを取得
                    impressions = row.get('impressions', '-')
                    clicks = row.get('clicks', '-')
                    ctr = row.get('ctr', '-')
                    position = row.get('position', '-')
                    csv_writer.writerow([query, page_url, impressions, clicks, ctr, position])
                    # worksheet.append_row([query, impressions, clicks, ctr, position])
                    print(f'検索クエリ: {query}, URL: {page_url}, 表示回数: {impressions}, クリック数: {clicks}, クリック率: {ctr}, 掲載順位: {position}')

    print(f'CSVファイルを以下のディレクトリにエクスポートしました: {output_file}')

except Exception as err:
    print(f'An error occurred: {err}')
